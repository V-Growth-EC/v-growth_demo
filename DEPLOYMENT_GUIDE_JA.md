# プロジェクトデプロイガイド

## 概要
このドキュメントでは、Next.jsプロジェクトをAWS EC2サーバーにデプロイし、PM2を使用してプロセス管理を行う方法を説明します。

## デプロイフロー

### 1. プロジェクトのパッケージ化とアップロード

#### 1.1 デプロイスクリプトの実行
```bash
# ローカルプロジェクトディレクトリで実行
./deploy-ec2-www.sh
```

このスクリプトは以下を行います：
- プロジェクトのパッケージ化
- AWS EC2サーバーへのアップロード
- プロジェクトが最新版であることを確保

#### 1.2 アップロードの検証
サーバーにファイルが正しくアップロードされているかチェックします。

### 2. AWSサーバーへの接続

#### 2.1 SSH接続
```bash
ssh -i ~/Downloads/mamezou_ssh.pem ec2-user@100.27.8.30
```

### 3. PM2プロセス管理

#### 3.1 現在のPM2ステータスの確認
```bash
pm2 status
```
`v-growth-demo`という名前のプロセスが実行されているか確認します。

#### 3.2 古いプロセスの停止と削除（必要に応じて）
```bash
# 古いPM2プロセスを削除
pm2 delete v-growth-demo
```

#### 3.3 新しいプロセスの開始
```bash
# プロジェクトディレクトリに移動
cd /var/www/next-app

# PM2を使用してアプリケーションを開始
pm2 start npm --name v-growth-demo -- start
```

#### 3.4 プロセス開始の検証
```bash
# PM2ステータスを確認
pm2 status

# プログラムが正常に実行されているか確認
pm2 logs v-growth-demo
```

### 4. ポート管理

#### 4.1 3000ポートの確認
```bash
# 3000ポートを使用しているプロセスがあるかを確認
sudo netstat -tulnp | grep 3000
```

#### 4.2 ポートを使用しているプロセスの強制終了（必要に応じて）
```bash
# ポートを使用しているプロセスのPIDを見つける
sudo netstat -tulnp | grep 3000

# プロセスを終了（{PID}を実際のプロセスIDに置き換える）
kill -9 {PID}

# 例：
kill -9 90391
```

### 5. PM2 よく使用するコマンド

```bash
# すべてのプロセスステータスを表示
pm2 status

# プロセスを停止
pm2 stop v-growth-demo

# プロセスログを表示
pm2 logs v-growth-demo

# 現在のPM2設定を保存
pm2 save

# 起動時の自動開始を設定
pm2 startup
```

## デプロイチェックリスト

- [ ] `deploy-ec2-www.sh`スクリプトを実行
- [ ] AWSサーバーにSSH接続
- [ ] 古いPM2プロセスを確認して削除（必要に応じて）
- [ ] 3000ポートが使用されていないか確認
- [ ] 新しいPM2プロセスを開始
- [ ] プロセスが正常に実行されているか確認
- [ ] ウェブサイト機能をテスト

## トラブルシューティング

### よくある問題

#### 1. ポートが使用されている
```bash
# ポートを確認
sudo netstat -tulnp | grep 3000

# 使用中のプロセスを終了
kill -9 {PID}
```

#### 2. PM2プロセスが開始できない
```bash
# エラーログを確認
pm2 logs v-growth-demo

# プロジェクトディレクトリを確認
ls -la /var/www/next-app
```

## 注意事項

1. **セキュアな接続**：セキュアなSSHキーを使用してサーバーに接続することを確認
2. **プロセス管理**：PM2を使用してサーバー再起動後もプロセスが自動実行されることを確保
3. **ポート管理**：ポート競合を避け、インスタンスが一つだけ実行されることを確保
4. **ログ監視**：潜在的な問題を発見するためにPM2ログを定期的に確認
5. **バックアップ**：デプロイ前に重要なデータをバックアップすることを推奨

## 連絡先

デプロイに関する問題がある場合、開発チームにお問い合わせください。


